generator client {
  provider     = "prisma-client-js"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                     String              @id @default(uuid())
  email                  String              @unique
  password               String
  nom                    String
  prenom                 String
  role                   UserRole            @default(GESTIONNAIRE)
  isActive               Boolean             @default(true)
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  etapePermissions       EtapePermission[]
  workflowEtapesValidees WorkflowEtape[]

  @@map("users")
}

model Technicien {
  id             String          @id @default(uuid())
  nom            String
  prenom         String
  telephone      String?
  email          String?
  specialite     String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  workflowEtapes WorkflowEtape[]

  @@map("techniciens")
}

model Vehicle {
  id              String     @id @default(uuid())
  immatriculation String     @unique
  marque          String
  modele          String
  annee           Int
  numeroSerie     String     @unique
  creePar         String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  workflows       Workflow[]

  @@index([marque])
  @@index([modele])
  @@index([annee])
  @@map("vehicles")
}

model Workflow {
  id                   String          @id @default(uuid())
  vehicleId            String
  statut               WorkflowStatus  @default(EN_ATTENTE)
  etapeActuelle        Int             @default(0)
  dateDebut            DateTime        @default(now())
  dateFin              DateTime?
  raisonAnnulation     String?
  dateAnnulation       DateTime?
  annulePar            String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  etapes               WorkflowEtape[]
  vehicle              Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([statut])
  @@index([etapeActuelle])
  @@index([vehicleId])
  @@index([dateDebut])
  @@map("workflows")
}

model WorkflowEtape {
  id                    String      @id @default(uuid())
  workflowId            String
  numeroEtape           Int
  nomEtape              String
  description           String?
  statut                EtapeStatus @default(EN_ATTENTE)
  formulaire            Json?
  dateDebut             DateTime?
  dateFin               DateTime?
  validePar             String?
  valideParId           String?
  technicienId          String?
  signatureGestionnaire String?     @db.Text
  signatureTechnicien   String?     @db.Text
  commentaires          String?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  workflow              Workflow    @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  valideParUser         User?       @relation(fields: [valideParId], references: [id], onDelete: SetNull)
  technicien            Technicien? @relation(fields: [technicienId], references: [id], onDelete: SetNull)

  @@unique([workflowId, numeroEtape])
  @@index([workflowId])
  @@index([statut])
  @@index([numeroEtape])
  @@index([valideParId])
  @@index([technicienId])
  @@map("workflow_etapes")
}

model EtapeDefinition {
  id               String            @id @default(uuid())
  numeroEtape      Int               @unique
  nom              String
  description      String?
  champsFormulaire Json?
  ordre            Int               @default(0)
  estObligatoire   Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  permissions      EtapePermission[]

  @@map("etape_definitions")
}

model EtapePermission {
  id                String          @id @default(uuid())
  etapeDefinitionId String
  userId            String
  permissionType    PermissionType
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  etapeDefinition   EtapeDefinition @relation(fields: [etapeDefinitionId], references: [id], onDelete: Cascade)
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([etapeDefinitionId, userId, permissionType])
  @@index([userId, etapeDefinitionId])
  @@index([permissionType])
  @@map("etape_permissions")
}

model HistoriqueModification {
  id               String   @id @default(uuid())
  entite           String
  entiteId         String
  action           String
  modifiePar       String
  dateModification DateTime @default(now())
  anciennesValeurs Json?
  nouvellesValeurs Json?
  commentaire      String?

  @@index([entiteId])
  @@index([entite])
  @@index([dateModification])
  @@index([modifiePar])
  @@map("historique_modifications")
}

enum UserRole {
  ADMIN
  GESTIONNAIRE
}

enum WorkflowStatus {
  EN_ATTENTE
  EN_COURS
  TERMINE
  ANNULE
}

enum EtapeStatus {
  EN_ATTENTE
  EN_COURS
  TERMINE
  BLOQUE
}

enum PermissionType {
  VIEW
  START
  EDIT
  VALIDATE
  EDIT_COMPLETED
}
